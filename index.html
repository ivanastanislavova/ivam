<!DOCTYPE html>
<html>
  <head>
    <title>AR DONA'm MÓN - SLAM WebXR</title>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene
      xr-mode-ui="enabled: true"
      webxr="mode: ar; optionalFeatures: hit-test;"
      embedded
      background="color: #000">

      <!-- Activos -->
      <a-assets>
        <a-asset-item id="mujerModel" src="mujer.glb"></a-asset-item>
      </a-assets>

      <!-- Cámara -->
      <a-entity camera look-controls></a-entity>

      <!-- Retículo -->
      <a-entity id="reticle"
        geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.06"
        material="color: #5f68c4"
        rotation="-90 0 0"
        visible="false">
      </a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent('ar-hit-test', {
        init: function () {
          const sceneEl = this.el.sceneEl;
          const renderer = sceneEl.renderer;

          renderer.xr.addEventListener('sessionstart', async () => {
            const session = renderer.xr.getSession();
            const viewerSpace = await session.requestReferenceSpace('viewer');
            const localSpace = await session.requestReferenceSpace('local');
            const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

            sceneEl.addEventListener('enter-vr', () => {
              if (sceneEl.is('ar-mode')) {
                this.reticle = document.getElementById('reticle');
                this.reticle.object3D.visible = true;
              }
            });

            this.el.sceneEl.addEventListener('tick', () => {
              const frame = renderer.xr.getFrame();
              if (!frame) return;
              const results = frame.getHitTestResults(hitTestSource);
              if (results.length > 0) {
                const pose = results[0].getPose(localSpace);
                this.reticle.object3D.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                this.reticle.object3D.visible = true;
              }
            });

            document.body.addEventListener('click', () => {
              if (this.reticle && this.reticle.object3D.visible) {
                const mujer = document.createElement('a-entity');
                mujer.setAttribute('gltf-model', '#mujerModel');
                mujer.setAttribute('scale', '0.5 0.5 0.5');
                mujer.object3D.position.copy(this.reticle.object3D.position);
                sceneEl.appendChild(mujer);
              }
            });
          });
        }
      });

      document.querySelector('a-scene').setAttribute('ar-hit-test', '');
    </script>
  </body>
</html>
